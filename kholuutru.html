<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n l√Ω ·∫£nh & th∆∞ m·ª•c</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f1f5f9; }
h2 { margin-bottom: 10px; }
.btn  {
  padding: 8px 14px;
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin: 5px;
}
.btn:hover { background:#1e40af; }
input[type=text] { padding: 6px; border-radius: 5px; border: 1px solid #ccc; }
.thumb { max-width: 120px; margin: 5px; border-radius: 6px; cursor: pointer; }
.del { background: #dc2626; margin-top: 4px; }
.folder { background:#fff; padding:12px; border-radius:10px; margin-top:12px; box-shadow:0 4px 15px rgba(0,0,0,0.07); }
#header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }

/* Overlay xem ·∫£nh full m√†n h√¨nh */
#imageOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#imageOverlay img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
#imageOverlay .closeBtn, #imageOverlay .downloadBtn {
  position: absolute;
  top: 20px;
  padding: 10px 16px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
#imageOverlay .closeBtn {
  right: 20px;
  background: #dc2626;
  color: #fff;
}
#imageOverlay .closeBtn:hover { background: #b91c1c; }

#imageOverlay .downloadBtn {
  right: 140px;
  background: #16a34a;
  color: #fff;
}
#imageOverlay .downloadBtn:hover { background: #15803d; }
</style>
</head>
<body>

<div id="header">
  <h2>Kho l∆∞u tr·ªØ</h2>
  <div>
    <span id="userDisplay"></span>
    <button class="btn" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
  </div>
</div>

<label>T√™n th∆∞ m·ª•c m·ªõi:</label>
<input type="text" id="folderNameInput" placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c">
<button class="btn" id="createFolderBtn">T·∫°o th∆∞ m·ª•c</button>

<div id="folderList"></div>

<!-- Overlay full ·∫£nh -->
<div id="imageOverlay">
  <img id="fullImage" src="">
  <button class="downloadBtn" id="downloadBtn">T·∫£i xu·ªëng</button>
  <button class="closeBtn" onclick="closeOverlay()">ƒê√≥ng</button>
</div>

<script>
/* ==== Ki·ªÉm tra ƒëƒÉng nh·∫≠p ==== */
let username = localStorage.getItem("dangnhap_hien_tai");
if(!username){ 
  alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); 
  window.location.href="dangnhap.html"; 
}
document.getElementById("userDisplay").textContent = username;
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("dangnhap_hien_tai");
  window.location.href="dangnhap.html";
});

/* ==== IndexedDB setup ==== */
let db;
const request = indexedDB.open("UserFolderDB",1);
request.onupgradeneeded = function(e){
  db = e.target.result;
  db.createObjectStore("users",{ keyPath: "username" });
};
request.onsuccess = function(e){
  db = e.target.result;
  loadFolders();
};

/* ==== T·∫°o th∆∞ m·ª•c m·ªõi ==== */
document.getElementById("createFolderBtn").addEventListener("click", ()=>{
  const name = document.getElementById("folderNameInput").value.trim();
  if(!name) return alert("Nh·∫≠p t√™n th∆∞ m·ª•c");
  
  const tx = db.transaction("users","readwrite");
  const store = tx.objectStore("users");
  store.get(username).onsuccess = function(e){
    let data = e.target.result;
    if(!data) data = { username, folders: [] };
    if(data.folders.find(f=>f.name===name)){ alert("T√™n th∆∞ m·ª•c ƒë√£ t·ªìn t·∫°i!"); return; }
    data.folders.push({ name, images: [] });
    store.put(data);
    tx.oncomplete = loadFolders;
  };
  document.getElementById("folderNameInput").value="";
});

/* ==== Load t·∫•t c·∫£ th∆∞ m·ª•c & ·∫£nh ==== */
function loadFolders(){
  const container = document.getElementById("folderList");
  container.innerHTML="";
  const tx = db.transaction("users","readonly");
  const store = tx.objectStore("users");
  store.get(username).onsuccess=function(e){
    const data = e.target.result;
    if(!data) return;
    data.folders.forEach((folder,index)=>{
      const safeName = encodeURIComponent(folder.name);
      const div = document.createElement("div");
      div.className="folder";
      div.innerHTML=`
        <h3>üìÇ ${folder.name} 
          <button class="btn del" onclick="deleteFolder('${folder.name}')">X√≥a th∆∞ m·ª•c</button>
        </h3>
        <input type="file" id="file-${safeName}" accept="image/*" style="display:none">
        <label for="file-${safeName}" class="btn">Ch·ªçn ·∫£nh</label>
        <button class="btn" onclick="uploadImage('${folder.name}')">T·∫£i ·∫£nh</button>
        <div id="images-${safeName}"></div>
      `;
      container.appendChild(div);
      renderImages(folder.name,folder.images);
    });
  };
}

/* ==== Upload ·∫£nh ==== */
function uploadImage(folderName){
  const safeName = encodeURIComponent(folderName);
  const inp = document.getElementById("file-" + safeName);
  const file = inp.files[0];
  if(!file) return alert("Ch·ªçn ·∫£nh!");
  
  const reader = new FileReader();
  reader.onload = function(){
    const tx = db.transaction("users","readwrite");
    const store = tx.objectStore("users");
    store.get(username).onsuccess = function(e){
      const data = e.target.result;
      const folder = data.folders.find(f=>f.name===folderName);
      folder.images.push(reader.result);
      store.put(data);
      tx.oncomplete = function(){
        loadFolders();
        inp.value = "";
      };
    };
  };
  reader.readAsDataURL(file);
}

/* ==== Render ·∫£nh ==== */
function renderImages(folderName,images){
  const safeName = encodeURIComponent(folderName);
  const wrap = document.getElementById("images-" + safeName);
  wrap.innerHTML="";
  images.forEach((src,index)=>{
    const img = document.createElement("img");
    img.src = src; 
    img.className="thumb";
    
    // Click m·ªü full m√†n h√¨nh
    img.onclick = function(){
      document.getElementById("fullImage").src = src;
      document.getElementById("imageOverlay").style.display = "flex";
      const dl = document.getElementById("downloadBtn");
      // T·∫°o link t·∫£i ƒë√∫ng c√°ch
      dl.onclick = function() {
        const a = document.createElement("a");
        a.href = src;
        a.download = "image.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };("href", src);
      dl.setAttribute("download", "image.png");
    }

    const delBtn = document.createElement("button");
    delBtn.className="btn del"; 
    delBtn.innerText="X√≥a";
    delBtn.onclick = ()=>deleteImage(folderName,index);

    wrap.appendChild(img);
    wrap.appendChild(delBtn);
  });
}

/* ==== X√≥a ·∫£nh ==== */
function deleteImage(folderName,index){
  if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?")) return;
  const tx = db.transaction("users","readwrite");
  const store = tx.objectStore("users");
  store.get(username).onsuccess=function(e){
    const data = e.target.result;
    const folder = data.folders.find(f=>f.name===folderName);
    folder.images.splice(index,1);
    store.put(data);
    tx.oncomplete = loadFolders;
  };
}

/* ==== X√≥a th∆∞ m·ª•c ==== */
function deleteFolder(folderName){
  if(!confirm("X√≥a th∆∞ m·ª•c n√†y?")) return;
  const tx = db.transaction("users","readwrite");
  const store = tx.objectStore("users");
  store.get(username).onsuccess=function(e){
    const data = e.target.result;
    data.folders = data.folders.filter(f=>f.name!==folderName);
    store.put(data);
    tx.oncomplete = loadFolders;
  };
}

/* ==== ƒê√≥ng overlay ==== */
function closeOverlay(){
  document.getElementById("imageOverlay").style.display = "none";
  document.getElementById("fullImage").src = "";
}
</script>
</body>
</html>
