<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>L·ªãch Nh·∫≠t K√Ω</title>
<style>
body {margin:0;font-family:Arial;background:#0f172a;color:#fff;display:flex;justify-content:center;padding:20px;position:relative;}
.app{width:100%;max-width:900px;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
button{background:#7c3aed;border:none;padding:8px 14px;color:#fff;border-radius:8px;cursor:pointer;}
button.secondary{background:#222;}
.calendar{display:flex;gap:20px;}
.month{flex:1;background:#111829;padding:16px;border-radius:12px;}
.controls{display:flex;justify-content:space-between;margin-bottom:12px;align-items:center;}
select{padding:6px;border-radius:6px;background:#1b2236;color:#fff;border:1px solid #444;}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;}
.dayHead{text-align:center;font-size:12px;color:#9aa2b2;}
.cell{padding:10px;min-height:70px;border-radius:8px;cursor:pointer;position:relative;background:#162040;}
.cell.out{opacity:0.25;}
.cell:hover{background:#1e2a55;}
.date{position:absolute;top:6px;right:8px;font-size:12px;}
.has{position:absolute;bottom:6px;left:8px;font-size:12px;background:#0005;padding:3px 5px;border-radius:4px;}
aside{width:240px;background:#111829;padding:16px;border-radius:12px;}
.modal, #quickViewOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;}
.modal{background:#0008;}
.card{background:#0f1a32;padding:20px;border-radius:12px;width:90%;max-width:500px;}
textarea{width:100%;height:180px;background:#0c1326;color:#fff;border:1px solid #344;padding:8px;border-radius:8px;}
#quickViewOverlay{background:#000c;flex-direction:column;overflow-y:auto;padding:20px;}
#quickViewOverlay h2{margin-bottom:20px;}
.quick-entry{background:#111829;padding:10px;border-radius:8px;margin-bottom:10px;white-space: pre-wrap;}
#btnQuickView{position:fixed;right:20px;bottom:20px;background:#7c3aed;padding:10px 14px;border:none;border-radius:8px;color:#fff;cursor:pointer;z-index:100;}
#closeQuickView{margin-top:10px;background:#222;}
</style>
</head>
<body>
<div class="app">
  <header>
    <h2>üìÖ L·ªãch Nh·∫≠t K√Ω</h2>
    <div>
      <span id="userInfo">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
      <button id="btnLogin" class="secondary">ƒêƒÉng nh·∫≠p</button>
      <button id="btnLogout" class="secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <div class="calendar">
    <div class="month">
      <div class="controls">
        <div style="display:flex;gap:6px;">
          <select id="selMonth"></select>
          <select id="selYear"></select>
        </div>
        <button id="today">H√¥m nay</button>
      </div>

      <div class="grid">
        <div class="dayHead">T2</div><div class="dayHead">T3</div><div class="dayHead">T4</div>
        <div class="dayHead">T5</div><div class="dayHead">T6</div><div class="dayHead">T7</div><div class="dayHead">CN</div>
      </div>

      <div class="grid" id="cells"></div>
    </div>

    <aside>
      <h3>H∆∞·ªõng d·∫´n</h3>
      <p>B·∫•m v√†o c√°c ng√†y ƒë·ªÉ l∆∞u nh·∫≠t k√Ω.</p>
    </aside>
  </div>
</div>

<div id="modal" class="modal">
  <div class="card">
    <h3 id="modalTitle"></h3>
    <textarea id="entry"></textarea>
    <div style="margin-top:10px;text-align:right;display:flex;gap:10px;justify-content:flex-end;">
      <button id="saveEntry">L∆∞u</button>
      <button id="closeModal" class="secondary">ƒê√≥ng</button>
    </div>
  </div>
</div>

<div id="quickViewOverlay">
  <h2>Nh·∫≠t k√Ω nhanh</h2>
  <div id="quickEntries"></div>
  <button id="closeQuickView">ƒê√≥ng</button>
</div>

<button id="btnQuickView" style="background-color: aquamarine;color: black;">Xem nh·∫≠t k√Ω nhanh</button>

<script>
const cells = document.getElementById("cells");
const selMonth = document.getElementById("selMonth");
const selYear = document.getElementById("selYear");
const userInfo = document.getElementById("userInfo");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const modal = document.getElementById("modal");
const entry = document.getElementById("entry");
const modalTitle = document.getElementById("modalTitle");
const btnQuickView = document.getElementById("btnQuickView");
const quickViewOverlay = document.getElementById("quickViewOverlay");
const quickEntries = document.getElementById("quickEntries");
const closeQuickView = document.getElementById("closeQuickView");

let view = new Date();
let selectedDate = null;

// --- USERS ---
function getCurrentUser() {
  return localStorage.getItem("userId") || "guest";
}

function updateUserHeader(){
  const user = localStorage.getItem("dangnhap_hien_tai");
  if(user){
    userInfo.textContent = "Ng∆∞·ªùi d√πng: " + user;
    btnLogin.style.display = "none";
    btnLogout.style.display = "inline-block";
  } else {
    userInfo.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
    btnLogin.style.display = "inline-block";
    btnLogout.style.display = "none";
  }
}

btnLogout.onclick = ()=>{
  localStorage.removeItem("userId");
  localStorage.removeItem("dangnhap_hien_tai");
  window.location.href = "trangchu.html";
};

btnLogin.onclick = ()=>{ window.location.href = "dangnhap.html"; };

// --- Month & Year options ---
for(let m=1;m<=12;m++){
  const opt = document.createElement("option");
  opt.value = m-1;
  opt.textContent = "Th√°ng " + m;
  selMonth.appendChild(opt);
}
for(let y=1970;y<=2070;y++){
  const opt = document.createElement("option");
  opt.value = y;
  opt.textContent = y;
  selYear.appendChild(opt);
}

// --- Date key theo user ---
function dateKey(d){
  const userId = getCurrentUser();
  return `${userId}-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

// --- Render Calendar ---
function renderCalendar(){
  selMonth.value = view.getMonth();
  selYear.value = view.getFullYear();

  cells.innerHTML = "";
  let start = new Date(view.getFullYear(), view.getMonth(), 1);
  let offset = (start.getDay()+6)%7;
  let first = new Date(start);
  first.setDate(first.getDate() - offset);

  for(let i=0;i<42;i++){
    let d = new Date(first);
    d.setDate(first.getDate()+i);

    let div = document.createElement("div");
    div.className = "cell" + (d.getMonth()!==view.getMonth()?" out":"");
    div.innerHTML = `<div class='date'>${d.getDate()}</div>`;

    if(localStorage.getItem(dateKey(d))) div.style.background = "#2b3f73";
    else div.style.background = d.getMonth()!==view.getMonth() ? "#16204044" : "#162040";

    div.onclick = ()=>openEntry(d);
    cells.appendChild(div);
  }
}

selMonth.onchange = ()=>{ view.setMonth(parseInt(selMonth.value)); renderCalendar(); };
selYear.onchange = ()=>{ view.setFullYear(parseInt(selYear.value)); renderCalendar(); };
document.getElementById("today").onclick = ()=>{ view = new Date(); renderCalendar(); };

// --- Modal nh·∫≠t k√Ω ---
function openEntry(d){
  if(getCurrentUser() === "guest"){
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ghi nh·∫≠t k√Ω!");
    return;
  }
  selectedDate = d;
  modal.style.display = "flex";
  modalTitle.textContent = "Nh·∫≠t k√Ω - " + d.toLocaleDateString("vi-VN");
  entry.value = localStorage.getItem(dateKey(d)) || "";
}
document.getElementById("closeModal").onclick = ()=>modal.style.display="none";
document.getElementById("saveEntry").onclick = ()=>{
  localStorage.setItem(dateKey(selectedDate), entry.value);
  modal.style.display = "none";
  renderCalendar();
};

// --- Xem nhanh nh·∫≠t k√Ω ---
btnQuickView.onclick = ()=>{
  quickEntries.innerHTML = "";
  const userId = getCurrentUser();
  if(userId === "guest"){ alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem nh·∫≠t k√Ω!"); return; }

  for(let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(!key.startsWith(userId+"-")) continue;
    const value = localStorage.getItem(key);
    const parts = key.split("-");
    const dateParts = parts.slice(-3); // nƒÉm-th√°ng-ng√†y
    const date = dateParts.join("-");
    const div = document.createElement("div");
    div.className = "quick-entry";
    div.textContent = `${date}: ${value}`; // gi·ªØ xu·ªëng d√≤ng
    quickEntries.appendChild(div);
  }

  quickViewOverlay.style.display = "flex";
};
closeQuickView.onclick = ()=>quickViewOverlay.style.display="none";

// --- Init ---
updateUserHeader();
renderCalendar();
</script>
</body>
</html>
