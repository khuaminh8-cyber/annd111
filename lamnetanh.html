<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L√†m n√©t ·∫£nh ‚Äî Upload & Download</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;background:#f7f9fc;color:#111}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,.08);max-width:960px;margin:auto}
    h1{margin:0;font-size:22px;font-weight:600}

    .upload-btn{
      display:inline-block;
      padding:10px 16px;
      background:#0b69ff;
      color:#fff;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    .upload-btn:hover{opacity:0.9}
    #file{display:none}

    .controls{display:flex;flex-wrap:wrap;gap:16px;margin-top:16px;align-items:flex-end}
    label{font-size:14px;font-weight:500}
    input[type=range]{width:180px}

    canvas{max-width:100%;border-radius:8px;background:#000;margin-top:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .col{flex:1;min-width:260px}

    button{background:#0b69ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px}
    button.secondary{background:#edf2ff;color:#0b69ff}
    button:disabled{opacity:0.5;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="card">
  <div style="width: 50px; background-color: #061a07; padding: 10px;border-radius: 8px;" ><a href="trangchu.html" ><img src="ngoinha.jpg" alt="" width="100%" style="border-radius: 10px;"></a> <br><a href="tienichmorong.html" ><img src="muiten.jpg" alt="" width="100%" style="border-radius: 10px; margin-top: 20px;"></a></div>
    <h1 style="background-color: aquamarine; padding: 10px;font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; border-radius: 8px;">Trang l√†m n√©t ·∫£nh</h1> <br>

    <label class="upload-btn" for="file">üì§ T·∫£i ·∫£nh l√™n</label>
    <input id="file" type="file" accept="image/*">

    <div class="controls">
      <div>
        <label for="amount">ƒê·ªô m·∫°nh (Amount): <span id="amountVal">1.0</span></label><br>
        <input id="amount" type="range" min="0" max="3" step="0.01" value="1">
      </div>
      <div>
        <label for="radius">B√°n k√≠nh l√†m n√©t (Radius): <span id="radiusVal">2</span></label><br>
        <input id="radius" type="range" min="0" max="10" step="0.5" value="2">
      </div>

      <button id="sharpenBtn">üîß L√†m n√©t ·∫£nh</button>
      <button id="downloadBtn" class="secondary">‚¨áÔ∏è T·∫£i xu·ªëng</button>
    </div>

    <div class="row">
      <div class="col">
        <label style="font-weight: 600;color: rgb(4, 7, 8);background-color: rgb(97, 250, 199);padding: 5px; border-radius: 4px;">·∫¢nh g·ªëc</label>
        <canvas id="originalCanvas"></canvas>
      </div>
      <div class="col">
        <label style="font-weight: 600;color: rgb(4, 7, 8);background-color: rgb(225, 150, 231);padding: 5px; border-radius: 4px;">·∫¢nh sau khi l√†m n√©t</label>
        <canvas id="resultCanvas"></canvas>
      </div>
    </div>
  </div>

<script>
const fileInput = document.getElementById('file');
const originalCanvas = document.getElementById('originalCanvas');
const resultCanvas = document.getElementById('resultCanvas');
const amountRange = document.getElementById('amount');
const radiusRange = document.getElementById('radius');
const amountVal = document.getElementById('amountVal');
const radiusVal = document.getElementById('radiusVal');
const sharpenBtn = document.getElementById('sharpenBtn');
const downloadBtn = document.getElementById('downloadBtn');

let originalImg = new Image();
let lastImageSize = {w:0,h:0};

function fitSize(w,h,maxSide=1200){
  if(Math.max(w,h) <= maxSide) return {w,h};
  const ratio = maxSide / Math.max(w,h);
  return {w: Math.round(w*ratio), h: Math.round(h*ratio)};
}

function drawImageToCanvas(img, canvas){
  const ctx = canvas.getContext('2d');
  const size = fitSize(img.width,img.height,1200);
  canvas.width = size.w; canvas.height = size.h;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
}

fileInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  originalImg = new Image();
  originalImg.onload = ()=>{
    drawImageToCanvas(originalImg, originalCanvas);
    drawImageToCanvas(originalImg, resultCanvas);
    lastImageSize = {w: originalCanvas.width, h: originalCanvas.height};
    URL.revokeObjectURL(url);
  }
  originalImg.src = url;
});

amountRange.addEventListener('input', ()=> amountVal.textContent = amountRange.value);
radiusRange.addEventListener('input', ()=> radiusVal.textContent = radiusRange.value);

async function unsharpMask(amount, blurRadius){
  if(!originalCanvas.width) return;
  const w = lastImageSize.w; const h = lastImageSize.h;

  const tempOrig = document.createElement('canvas');
  tempOrig.width = w; tempOrig.height = h;
  const toCtx = tempOrig.getContext('2d');
  toCtx.drawImage(originalCanvas,0,0);

  const tempBlur = document.createElement('canvas');
  tempBlur.width = w; tempBlur.height = h;
  const tbCtx = tempBlur.getContext('2d');
  tbCtx.filter = `blur(${blurRadius}px)`;
  tbCtx.drawImage(tempOrig,0,0);
  tbCtx.filter = 'none';

  const origData = toCtx.getImageData(0,0,w,h);
  const blurData = tbCtx.getImageData(0,0,w,h);
  const outCtx = resultCanvas.getContext('2d');
  const outImg = outCtx.createImageData(w,h);

  const od = origData.data;
  const bd = blurData.data;
  const rd = outImg.data;

  for(let i=0;i<od.length;i+=4){
    for(let c=0;c<3;c++){
      const o = od[i+c];
      const b = bd[i+c];
      let val = o + amount * (o - b);
      if(val < 0) val = 0;
      if(val > 255) val = 255;
      rd[i+c] = Math.round(val);
    }
    rd[i+3] = od[i+3];
  }

  resultCanvas.width = w;
  resultCanvas.height = h;
  outCtx.putImageData(outImg,0,0);
}

sharpenBtn.addEventListener('click', async ()=>{
  if(!originalCanvas.width){ alert('Vui l√≤ng t·∫£i ·∫£nh l√™n.'); return; }
  sharpenBtn.disabled = true;
  downloadBtn.disabled = true;

  try{
    await unsharpMask(parseFloat(amountRange.value), parseFloat(radiusRange.value));
  }catch(err){
    alert('L·ªói khi x·ª≠ l√Ω ·∫£nh: '+err.message);
  }

  sharpenBtn.disabled = false;
  downloadBtn.disabled = false;
});

downloadBtn.addEventListener('click', ()=>{
  if(!resultCanvas.width){ alert('Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ t·∫£i.'); return; }
  resultCanvas.toBlob(blob=>{
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'anh-lam-net.png';
    a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
});
</script>
</body>
</html>